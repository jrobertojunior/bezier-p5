<html>
  <head> </head>
  <body>
    <!-- <h1>Curva Bezier</h1> -->
    <script src="https://cdn.jsdelivr.net/npm/p5@1.4.1/lib/p5.js"></script>
    <script>
      window.addEventListener("contextmenu", (e) => e.preventDefault());
      points = [];
      resolution = 100; // n points for each curve
      DISTANCE_TO_SELECT = 15; // distance to select a point

      pointMoving = false;
      let selectedPointIndex;
      let onTopOfControlPoint = false;
      let onTopOfCurve = false;

      function calculateBezier(points) {
        result = [];
        start = points[0];
        for (let t = 0; t <= 1; t += 1 / resolution) {
          controls = points;

          while (controls.length > 1) {
            aux = [];

            for (i = 0; i < controls.length - 1; i++) {
              aux[i] = interpolate(t, controls[i], controls[i + 1]);
            }
            controls = aux;
          }

          result.push(controls[0]);
        }
        return result;
      }
      function mouseDragged() {
        if (pointMoving) {
          points[selectedPointIndex].x = mouseX;
          points[selectedPointIndex].y = mouseY;
        }
      }
      function mousePressed() {
        // remove something
        if (mouseButton === RIGHT) {
          // remove point
          if (onTopOfControlPoint) {
            points.splice(selectedPointIndex, 1);
            selectedPointIndex = undefined;
            // remove curve
          } else if (onTopOfCurve) {
            points = [];
          }
          return;
        }

        // move point
        if (onTopOfControlPoint) {
          pointMoving = true;
          return;
        }

        // add point
        points.push({ x: mouseX, y: mouseY });
      }

      function mouseReleased() {
        pointMoving = false;
      }

      function interpolate(t, p0, p1) {
        return { x: (1 - t) * p0.x + t * p1.x, y: (1 - t) * p0.y + t * p1.y };
      }

      let clearButton;
      skipAddPoint = false;

      function setup() {
        createCanvas(400, 400);
        strokeWeight(4);
        points = [
          { x: 63, y: 200 },
          { x: 174, y: 118 },
          { x: 215, y: 236 },
          { x: 331, y: 160 },
        ];
        clearButton = createButton("clear");
        clearButton.position(14, 380);
        clearButton.mousePressed(() => {
          points = [];
          skipAddPoint = true;
        });
      }

      function draw() {
        onTopOfControlPoint = false;
        onTopOfCurve = false;
        clear();
        background(50);
        if (points.length < 1) return;

        // get the bezier curve
        thecurve = calculateBezier(points);

        // check if mouse is on top of a control point
        for (let i = 0; i < points.length; i++) {
          if (
            dist(mouseX, mouseY, points[i].x, points[i].y) <= DISTANCE_TO_SELECT
          ) {
            onTopOfControlPoint = true;
            selectedPointIndex = i;
          }
        }
        if (!onTopOfControlPoint) {
          // check if mouse is on top of a bezier curve
          for (let i = 0; i < thecurve.length - 1; i++) {
            if (
              dist(mouseX, mouseY, thecurve[i].x, thecurve[i].y) <=
              DISTANCE_TO_SELECT
            ) {
              onTopOfCurve = true;
              selectedPointIndex = i;
            }
          }
        }

        // draw bezier curve
        // set curve color
        if (onTopOfCurve) {
          stroke(250, 50, 100);
          strokeWeight(6);
        } else {
          stroke(237, 34, 93);
          strokeWeight(4);
        }
        for (i = 0; i < thecurve.length - 1; i++) {
          line(
            thecurve[i].x,
            thecurve[i].y,
            thecurve[i + 1].x,
            thecurve[i + 1].y
          );
        }

        // draw points and its lines
        for (i = 0; i < points.length; i++) {
          // set line color
          stroke(237, 34, 93, 50);
          strokeWeight(3);

          if (i < points.length - 1) {
            line(points[i].x, points[i].y, points[i + 1].x, points[i + 1].y);
          }

          // set point color
          stroke(255, 255, 255, 100);
          strokeWeight(6);
          point(points[i].x, points[i].y);
        }

        // draw point controller
        if (onTopOfControlPoint) {
          circle(mouseX, mouseY, 10);
        }
      }
    </script>
  </body>
</html>
